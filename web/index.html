<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>IA-HASH · Verificación de salidas IA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="IA-HASH genera y verifica huellas criptográficas de salidas IA (Prompt + Respuesta) sin blockchain ni dependencias de proveedor."
    />
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <!-- Barra superior -->
    <header class="top-bar">
      <div class="top-bar-inner">
        <div class="brand">
          <div class="brand-logo">IA</div>
          <div class="brand-text">
            <span class="brand-title">IA-HASH</span>
            <span class="brand-subtitle">Prompt + Respuesta · Verificables</span>
          </div>
        </div>
        <nav class="top-nav">
          <a href="#issuer" class="nav-link nav-link-active">Emitir</a>
          <a href="#verifier" class="nav-link">Verificar</a>
          <a href="#how" class="nav-link">Cómo funciona</a>
          <a href="https://github.com/IAHASH/iahash" class="nav-link" target="_blank" rel="noreferrer">
            GitHub
          </a>
        </nav>
      </div>
    </header>

    <main class="page">
      <div class="layout">
        <!-- EMISOR -->
        <section id="issuer" class="card card-main">
          <div class="card-info">
            <h2 class="card-title">Generar un nuevo IA-HASH</h2>
            <p class="card-description">
              Pega el <strong>prompt maestro</strong> y la <strong>respuesta</strong> de tu IA.
              IA-HASH generará un documento firmado que podrás compartir y verificar más tarde.
            </p>
          </div>

          <form class="form" onsubmit="return false;">
            <div class="field-group">
              <label class="field-label" for="prompt">
                Prompt maestro (texto exacto enviado al LLM)
              </label>
              <textarea id="prompt" class="field-input field-textarea" rows="6"></textarea>
            </div>

            <div class="field-group">
              <label class="field-label" for="response">
                Respuesta del LLM (texto completo devuelto por tu IA)
              </label>
              <textarea id="response" class="field-input field-textarea" rows="8"></textarea>
            </div>

            <div class="field-grid">
              <div class="field-group">
                <label class="field-label" for="model">Modelo</label>
                <input
                  id="model"
                  class="field-input"
                  placeholder="gpt-5.1, claude-3.5, maia…"
                />
              </div>
              <div class="field-group">
                <label class="field-label" for="prompt-id">
                  Prompt ID <span class="field-optional">(opcional)</span>
                </label>
                <input
                  id="prompt-id"
                  class="field-input"
                  placeholder="cv_v1, diag_psico_v1…"
                />
              </div>
              <div class="field-group">
                <label class="field-label" for="subject-id">
                  Subject ID <span class="field-optional">(opcional)</span>
                </label>
                <input
                  id="subject-id"
                  class="field-input"
                  placeholder="user-123, candidato-456…"
                />
              </div>
            </div>

            <div class="form-footer">
              <button id="btn-issue" class="btn btn-primary" type="button">
                Generar IA-HASH
              </button>
              <button id="btn-issue-clear" class="btn btn-secondary" type="button">
                Limpiar
              </button>
              <span id="issue-status" class="form-status">
                Listo para generar un nuevo documento.
              </span>
            </div>

            <div class="field-group">
              <label class="field-label">
                Resultado &amp; documento IA-HASH
              </label>
              <div class="result-block">
                <div class="result-header">
                  <span id="issue-badge" class="badge">Sin verificar</span>
                  <span id="issue-hint" class="result-hint">
                    Genera un IA-HASH o reutiliza este JSON para verificarlo en el panel de la derecha.
                  </span>
                </div>
                <pre id="issue-json" class="code-block mono">{}</pre>
              </div>
            </div>
          </form>
        </section>

        <!-- VERIFICADOR -->
        <section id="verifier" class="card card-side">
          <div class="card-info">
            <h2 class="card-title">Verificar un documento IA-HASH</h2>
            <p class="card-description">
              Pega el <strong>JSON IA-HASH</strong> o usa el último generado.
              Comprobaremos hashes, metadatos y firma Ed25519.
            </p>
          </div>

          <div class="form">
            <div class="field-group">
              <label class="field-label" for="verify-json">
                Documento IA-HASH a verificar
              </label>
              <textarea
                id="verify-json"
                class="field-input field-textarea mono"
                rows="12"
                placeholder='{ "version": "IA-HASH-1", ... }'
              ></textarea>
            </div>

            <div class="form-footer">
              <button id="btn-use-last" class="btn btn-secondary" type="button">
                Usar último generado
              </button>
              <button id="btn-verify" class="btn btn-primary" type="button">
                Verificar IA-HASH
              </button>
              <span id="verify-status" class="form-status">
                Esperando documento…
              </span>
            </div>

            <div class="result-block">
              <div class="result-header">
                <span id="verify-badge" class="badge">Sin verificar</span>
                <span id="verify-hint" class="result-hint">
                  El resultado de la verificación aparecerá aquí.
                </span>
              </div>
              <div id="verify-extra" class="result-hint"></div>
            </div>

            <div id="verify-hash-result"></div>

            <div id="verify-seal" style="display:none; margin-top:8px;">
              <img
                src="/static/badge-verified.svg"
                alt="IA-HASH Verified"
                style="max-width:180px; height:auto;"
              />
            </div>
          </div>
        </section>
      </div>

      <section id="prompt-url" class="card card-side">
        <div class="card-info">
          <h2 class="card-title">Verificar respuesta (ChatGPT link)</h2>
          <p class="card-description">
            Pega la URL compartida de ChatGPT y generaremos el IA-HASH completo para el prompt maestro.
          </p>
        </div>

        <div class="form">
          <div class="field-group">
            <label class="field-label" for="prompt-url-id">Prompt ID</label>
            <input id="prompt-url-id" class="field-input" value="cv-honesto-v1" />
          </div>

          <div class="field-grid">
            <div class="field-group">
              <label class="field-label" for="prompt-url-provider">Proveedor</label>
              <select id="prompt-url-provider" class="field-input">
                <option value="chatgpt">ChatGPT</option>
              </select>
            </div>
            <div class="field-group">
              <label class="field-label" for="prompt-url-share">ChatGPT share URL</label>
              <input
                id="prompt-url-share"
                class="field-input"
                placeholder="https://chatgpt.com/share/…"
                type="url"
              />
            </div>
          </div>

          <div class="form-footer">
            <button id="btn-verify-url" class="btn btn-primary" type="button">Verificar con IA-HASH</button>
            <span id="prompt-url-status" class="form-status">Pega el enlace compartido y pulsa verificar.</span>
          </div>

          <div id="prompt-url-result"></div>
        </div>
      </section>

      <!-- CÓMO FUNCIONA -->
      <section id="how" class="card card-info">
        <h2 class="card-title">Cómo funciona IA-HASH v1</h2>
        <ul class="info-list">
          <li>
            <strong>1. Normalización</strong>: se unifican saltos de línea (<code>\\n</code>) y
            espacios finales para que el texto sea reproducible.
          </li>
          <li>
            <strong>2. Hash de prompt y respuesta</strong>:
            <code>h_prompt = SHA256(normalise(prompt))</code>,
            <code>h_respuesta = SHA256(normalise(respuesta))</code>.
          </li>
          <li>
            <strong>3. Hash combinado</strong>:
            <code>h_total = SHA256(version | prompt_id | h_prompt | h_respuesta | modelo | timestamp)</code>.
          </li>
          <li>
            <strong>4. Firma Ed25519</strong>: se firma <code>h_total</code> con la clave privada de
            <code>iahash.com</code>. La clave pública está en
            <code>/public-key.pem</code>.
          </li>
          <li>
            <strong>5. Verificación</strong>: cualquiera puede recalcular hashes y comprobar la firma con la clave pública,
            incluso offline.
          </li>
        </ul>
        <p class="info-note">
          El código completo del protocolo está publicado en el repositorio:
          <code>iahash/crypto.py</code>, <code>iahash/issuer.py</code>,
          <code>iahash/verifier.py</code>. :contentReference[oaicite:6]{index=6}
        </p>
      </section>
    </main>

    <footer class="page-footer">
      <span>IA-HASH · abierto y sin blockchain.</span>
      <span>Repositorio: <a href="https://github.com/IAHASH/iahash" target="_blank" rel="noreferrer">github.com/IAHASH/iahash</a></span>
    </footer>

    <script src="/static/shared.js"></script>
    <script>
      const $ = (id) => document.getElementById(id);

      const issueJsonEl = $("issue-json");
      const issueStatusEl = $("issue-status");
      const issueBadgeEl = $("issue-badge");
      const issueHintEl = $("issue-hint");

      const verifyJsonEl = $("verify-json");
      const verifyStatusEl = $("verify-status");
      const verifyBadgeEl = $("verify-badge");
      const verifyHintEl = $("verify-hint");
      const verifyExtraEl = $("verify-extra");
      const verifySealEl = $("verify-seal");
      const verifyHashResultEl = $("verify-hash-result");

      const promptUrlStatusEl = $("prompt-url-status");
      const promptUrlResultEl = $("prompt-url-result");

      let lastIssued = null;

      $("btn-issue").addEventListener("click", async () => {
        const payload = {
          prompt_maestro: $("prompt").value,
          respuesta: $("response").value,
          modelo: $("model").value || "unknown",
          prompt_id: $("prompt-id").value || null,
          subject_id: $("subject-id").value || null,
        };

        issueStatusEl.textContent = "Generando documento IA-HASH…";
        issueBadgeEl.className = "badge";
        issueBadgeEl.textContent = "Procesando";

        try {
          const res = await fetch("/api/issue", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            issueStatusEl.textContent = "Error al generar el documento (HTTP " + res.status + ").";
            issueBadgeEl.className = "badge badge-error";
            issueBadgeEl.textContent = "Error";
            return;
          }
          const data = await res.json();
          lastIssued = data;
          issueJsonEl.textContent = JSON.stringify(data, null, 2);
          issueStatusEl.textContent = "Documento IA-HASH generado correctamente.";
          issueBadgeEl.className = "badge badge-success";
          issueBadgeEl.textContent = "Generado";
          issueHintEl.textContent = "Puedes copiar este JSON o verificarlo directamente en el panel de la derecha.";
        } catch (e) {
          issueStatusEl.textContent = "Error de red al contactar con la API.";
          issueBadgeEl.className = "badge badge-error";
          issueBadgeEl.textContent = "Error";
        }
      });

      $("btn-issue-clear").addEventListener("click", () => {
        $("prompt").value = "";
        $("response").value = "";
        $("model").value = "";
        $("prompt-id").value = "";
        $("subject-id").value = "";
        issueJsonEl.textContent = "{}";
        lastIssued = null;
        issueStatusEl.textContent = "Listo para generar un nuevo documento.";
        issueBadgeEl.className = "badge";
        issueBadgeEl.textContent = "Sin verificar";
        issueHintEl.textContent =
          "Genera un IA-HASH o reutiliza este JSON para verificarlo en el panel de la derecha.";
      });

      $("btn-use-last").addEventListener("click", () => {
        if (!lastIssued) {
          verifyStatusEl.textContent = "No hay ningún documento generado todavía.";
          return;
        }
        verifyJsonEl.value = JSON.stringify(lastIssued, null, 2);
        verifyStatusEl.textContent = "Documento cargado desde el último IA-HASH generado.";
      });

      $("btn-verify").addEventListener("click", async () => {
        verifySealEl.style.display = "none";
        verifyExtraEl.textContent = "";
        verifyBadgeEl.className = "badge";
        verifyBadgeEl.textContent = "Verificando";
        verifyStatusEl.textContent = "Verificando documento…";
        renderIAHashResult(verifyHashResultEl, null, {});

        let doc;
        try {
          doc = JSON.parse(verifyJsonEl.value);
        } catch (e) {
          verifyStatusEl.textContent = "JSON inválido. Revisa el formato.";
          verifyBadgeEl.className = "badge badge-error";
          verifyBadgeEl.textContent = "Error";
          renderError(verifyHashResultEl, "JSON inválido. Revisa el formato.");
          return;
        }

        try {
          const res = await fetch("/api/verify", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(doc),
          });
          if (!res.ok) {
            verifyStatusEl.textContent = "Error al verificar (HTTP " + res.status + ").";
            verifyBadgeEl.className = "badge badge-error";
            verifyBadgeEl.textContent = "Error";
            renderError(verifyHashResultEl, "Error al verificar: " + res.status);
            return;
          }
          const data = await res.json();
          renderIAHashResult(verifyHashResultEl, doc, {
            valid: data.valid,
            error: data.valid ? null : data.reason,
          });

          if (data.valid) {
            verifyBadgeEl.className = "badge badge-success";
            verifyBadgeEl.textContent = "Válido";
            verifyStatusEl.textContent = "Documento IA-HASH válido y sin modificar.";
            verifyHintEl.textContent = "Hash de prompt, respuesta y metadatos coinciden. Firma Ed25519 correcta.";
            verifyExtraEl.textContent = data.reason || "";
            verifySealEl.style.display = "block";
          } else {
            verifyBadgeEl.className = "badge badge-error";
            verifyBadgeEl.textContent = "No válido";
            verifyStatusEl.textContent = "El documento IA-HASH no es válido.";
            verifyHintEl.textContent =
              "Algún hash no coincide o la firma no ha podido verificarse con la clave pública.";
            verifyExtraEl.textContent = data.reason || "";
          }
        } catch (e) {
          verifyStatusEl.textContent = "Error de red al contactar con la API.";
          verifyBadgeEl.className = "badge badge-error";
          verifyBadgeEl.textContent = "Error";
          renderError(verifyHashResultEl, "No se pudo contactar con la API de verificación.");
        }
      });

      $("btn-verify-url").addEventListener("click", async () => {
        const btn = $("btn-verify-url");
        const promptId = $("prompt-url-id").value.trim();
        const provider = $("prompt-url-provider").value;
        const shareUrl = $("prompt-url-share").value.trim();

        promptUrlStatusEl.textContent = "Llamando a IA-HASH…";
        btn.disabled = true;
        renderIAHashResult(promptUrlResultEl, null, {});

        if (!shareUrl) {
          promptUrlStatusEl.textContent = "Pega una URL de chatgpt.com/share.";
          btn.disabled = false;
          renderError(promptUrlResultEl, "Debes pegar una URL válida de ChatGPT.");
          return;
        }

        try {
          const res = await fetch("/api/verify/prompt_url", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt_id: promptId, provider, share_url: shareUrl }),
          });

          if (!res.ok) {
            const detail = await res.text();
            promptUrlStatusEl.textContent = "No se pudo verificar el enlace.";
            renderError(promptUrlResultEl, detail || "Error de verificación");
            return;
          }

          const data = await res.json();
          promptUrlStatusEl.textContent = data.valid
            ? "IA-HASH generado y verificado a partir del enlace."
            : data.reason || "No verificado";

          renderIAHashResult(promptUrlResultEl, data.document, {
            valid: data.valid,
            error: data.valid ? null : data.reason,
          });
        } catch (err) {
          promptUrlStatusEl.textContent = "Error de red al contactar con la API.";
          renderError(promptUrlResultEl, "No se pudo recuperar la conversación compartida.");
        } finally {
          btn.disabled = false;
        }
      });
    </script>
  </body>
</html>
