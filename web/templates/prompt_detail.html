{% extends "base.html" %}
{% block content %}
  <div class="section">
    <h2>{{ prompt.title }}</h2>
    <p class="muted">{{ prompt.description }}</p>
  </div>

  <div class="card">
    <h3>Prompt Maestro</h3>
    <textarea class="input" id="prompt-text" readonly style="height: 220px;">{{ prompt.body }}</textarea>
    <button class="button" style="margin-top: 10px;" onclick="copyPrompt()">Copiar Prompt</button>
  </div>

  <div class="card">
    <h3>Verificar respuesta (ChatGPT link)</h3>
    <input id="conv-url" class="input" placeholder="https://chatgpt.com/share/..." style="margin-top: 10px;">
    
    <!-- IMPORTANTE: ahora enviamos prompt.id, NO el slug -->
    <button class="button" style="margin-top: 10px;" onclick="verifyConversation({{ prompt.id }})">
      Verificar con IA-HASH
    </button>

    <pre id="conv-log" class="muted" style="margin-top: 10px;"></pre>
  </div>

  <div class="card">
    <h3>Historial de verificaciones</h3>
    <p class="muted">Próximamente: aquí aparecerán los últimos IA-HASH emitidos para este prompt.</p>
  </div>

  <script>
    function copyPrompt() {
      const text = document.getElementById('prompt-text').value;
      navigator.clipboard.writeText(text);
      alert('Prompt copiado al portapapeles.');
    }

    async function verifyConversation(promptId) {
      const url = document.getElementById('conv-url').value;
      const payload = {
        url: url,
        prompt_id: promptId  // IMPORTANTE: numeric id
      };

      document.getElementById('conv-log').textContent = "Procesando verificación...";

      const res = await fetch('/api/verify/conversation', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      const json = await res.json();
      document.getElementById('conv-log').textContent = JSON.stringify(json, null, 2);
    }
  </script>

{% endblock %}
